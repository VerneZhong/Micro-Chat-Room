<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>消息盒子</title>
    <link rel="stylesheet" href="layui/css/layui.css">
    <link rel="stylesheet" href="css/msgbox.css">
</head>
<body>

<ul class="layim-msgbox" id="LAY_view"></ul>
<textarea title="消息模版" id="LAY_tpl" style="display:none;">
{{# layui.each(d.data, function(index, item){
  if(item.from){ }}
    <li data-uid="{{ item.from }}" data-fromGroup="{{ item.friendGroupId }}">
      <a href="/u/{{ item.from }}/" target="_blank">
        <img src="{{ item.user.avatar }}" class="layui-circle layim-msgbox-avatar">
      </a>
      <p class="layim-msgbox-user">
        <a href="/u/{{ item.from }}/" target="_blank">{{ item.user.username||'' }}</a>
        <span>{{ item.time }}</span>
      </p>
      <p class="layim-msgbox-content">
        {{ item.content }} 
        <span>{{ item.remark ? '备注: '+item.remark : '' }}</span>
      </p>
      <p class="layim-msgbox-btn">
        <button class="layui-btn layui-btn-small" data-type="agree">同意</button>
        <button class="layui-btn layui-btn-small layui-btn-primary" data-type="refuse">拒绝</button>
      </p>
    </li>
  {{# } else { }}
    <li class="layim-msgbox-system">
      <p><em>系统：</em>{{ item.content }}<span>{{ item.time }}</span></p>
    </li>
  {{# }
}); }}
</textarea>
<script src="layui/layui.js"></script>
<script>
    layui.use(['layim', 'flow'], function () {
        var layim = layui.layim
            , layer = layui.layer
            , laytpl = layui.laytpl
            , $ = layui.jquery
            , flow = layui.flow;

        let cache = {}; //用于临时记录请求到的数据

        // 当前用户信息
        let mine = JSON.parse(window.localStorage.getItem("mine"));
        //请求消息
        var renderMsg = function (page, callback) {
            $.ajax({
                type: "post",
                data: JSON.stringify({
                    page: page || 1,
                    userId: mine.mine.id
                }),
                url: "getMsgBox.do",
                dataType: 'JSON',
                contentType: "application/json",
                success: function (res) {
                    if (res.code !== 0) {
                        return layer.msg(res.msg);
                    }
                    // 记录来源用户信息
                    layui.each(res.data, function (index, item) {
                        cache[item.from] = item.user;
                    });
                    callback && callback(res.data, res.pages);
                }
            });
        };

        //消息信息流
        flow.load({
            elem: '#LAY_view' //流加载容器
            , isAuto: false
            , end: '<li class="layim-msgbox-tips">暂无更多新消息</li>'
            , done: function (page, next) { //加载下一页
                renderMsg(page, function (data, pages) {
                    var html = laytpl(LAY_tpl.value).render({
                        data: data
                        , page: page
                    });
                    next(html, page < pages);
                });
            }
        });

        //打开页面即把消息标记为已读
        /*
        $.post('/message/read', {
          type: 1
        });
        */

        //操作
        var active = {
            //同意
            agree: function (othis) {
                var li = othis.parents('li')
                    , uid = li.data('uid')
                    , from_group = li.data('fromGroup')
                    , user = cache[uid];
                //选择分组
                layim.setFriendGroup({
                    type: 'friend'
                    , username: user.username
                    , avatar: user.avatar
                    , group: mine.friend //获取好友分组数据
                    , submit: function (group, index) {
                        $.ajax({
                            type: "post",
                            data: JSON.stringify({
                                uid: uid //对方用户ID
                                , fromGroup: from_group // 对方设定的好友分组
                                , group: group // 我设定的好友分组
                            }),
                            url: "confirmAddFriend.do",
                            dataType: 'JSON',
                            contentType: "application/json",
                            success: function (res) {
                                if (res.code !== 0) {
                                    return layer.msg(res.msg);
                                }
                                //将好友追加到主面板
                                layim.addList({
                                    type: 'friend'
                                    , avatar: user.avatar //好友头像
                                    , username: user.username //好友昵称
                                    , groupid: group //所在的分组id
                                    , id: uid //好友ID
                                    , sign: user.sign //好友签名
                                });
                                layer.close(index);
                                othis.parent().html('已同意');
                            }
                        });
                    }
                });
            }

            //拒绝
            , refuse: function (othis) {
                var li = othis.parents('li')
                    , uid = li.data('uid');

                layer.confirm('确定拒绝吗？', function (index) {
                    $.post('/refuseFriend.do', {
                        uid: uid //对方用户ID
                    }, function (res) {
                        if (res.code != 0) {
                            return layer.msg(res.msg);
                        }
                        layer.close(index);
                        othis.parent().html('<em>已拒绝</em>');
                    });
                });
            }
        };

        $('body').on('click', '.layui-btn', function () {
            var othis = $(this), type = othis.data('type');
            active[type] ? active[type].call(this, othis) : '';
        });
    });
</script>
</body>
</html>
